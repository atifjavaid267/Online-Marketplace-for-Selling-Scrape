
<% first_id = current_user.id %>
<% if current_user.buyer? %>
  <% second_id = @order&.bid&.ad&.user_id %>
<% else %>
  <% second_id = @order&.bid&.user_id %>
<% end %>

<% noti = Notification.where(receiver_id: current_user.id, sender_id: second_id ).first %>
<% if noti %>
  <% noti.count = nil %>
  <% noti.read = true %>
  <% noti.save %>
<% end %>

<% messages = Message.where("(sender_id = ? AND receiver_id = ?) OR (sender_id = ? AND receiver_id = ?)", first_id, second_id, second_id, first_id) %>
<div id="chat-room" class = "pb-16">
  <div id="messages">
    <% unless messages.length.zero? %>
      <% last_date = messages.first.created_at.strftime("%B %d, %Y") %>
      <div class= "mb-5 pb-5">
        <div class="flex justify-center text-center mt-15">
        <p class="border rounded-md m-3 p-1"> <%= last_date %> </p>
        </div>
        <% messages.each do |message| %>
          <% if last_date != message.created_at.strftime("%B %d, %Y") %>
            <% last_date = message.created_at.strftime("%B %d, %Y")%>
            <div class="flex justify-center text-center">
              <p class="border rounded-md m-3 p-1"> <%= last_date %> </p>
            </div>
          <%end%>

          <div id = "user", data-user-id = <%= @current_user_id %>></div>
          <%if current_user.id == message.sender_id %>
            <div class="message text-right mr-5 mt-5">
              <span class="time text-xs text-gray-500"><%= message.created_at.strftime("%I:%M %p") %></span>
              <span class="content bg-blue-600 rounded-full px-3 py-2 m-1 text-white text-lg"><%= message.content %></span>
            </div>
          <% else %>
            <div class="message  text-left ml-5 mt-5">
              <span class="content bg-gray-500 rounded-full px-3 py-2 m-1 text-white text-lg"><%= message.content %></span>
              <span class="time text-xs text-gray-500"><%= message.created_at.strftime("%I:%M %p") %></span>
            </div>
          <% end %>
        <% end %>
      </div>
    <% end %>
    <div class=" pt-2 flex fixed bottom-0 w-full p-4 bg-white rounded-lg w-100">
      <%= form_for Message.new, url:messages_path, remote: true do |f| %>
        <%= f.hidden_field :sender_id, value: current_user.id %>
        <% if current_user.seller? %>
          <%= f.hidden_field :receiver_id, value: @order.bid.user_id %>
        <% else %>
          <%= f.hidden_field :receiver_id, value: @order.bid.ad.user_id %>
        <% end %>
        <%= f.hidden_field :order_id, value: @order.id %>
        <div class="flex flex-row w-full">
          <%= f.text_field :content, required: true, placeholder: "Enter your message",  :maxlength=>"110", class: "flex-1 mr-2 border-2 border-gray-300 py-2 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-600 focus:border-transparent" %>
          <%= f.submit "Send", class: "ml-3 bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-3 rounded-lg" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
  document.addEventListener("turbolinks:load", () => {
    if (window.location.pathname === "/messages/new") {
      const countElement = document.getElementById("count");
      localStorage.setItem("count", "0");
      countElement.innerHTML = "0";
      const notificationDropdown = document.getElementById("notification-dropdown");
      notificationDropdown.innerHTML = "";
      localStorage.setItem("notifications", JSON.stringify({ messageCounts: {}, notificationMessages: {} }));
    }
  });
</script>
